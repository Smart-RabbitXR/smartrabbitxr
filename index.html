<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Visor 360 – SmartRabbitXR</title>

  <!-- A-Frame: puedes dejar 1.0.4 como en Glitch o subir a 1.4.2 -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>

  <style>
    html,body{margin:0;height:100%;background:#000;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #ui{position:fixed;inset:0;display:flex;flex-direction:column;gap:12px;
        align-items:center;justify-content:center;background:#000;z-index:10}
    #title{font-weight:600}
    #btn{padding:14px 18px;border:0;border-radius:10px;cursor:pointer}
    #note{font:12px/1.3 monospace;opacity:.8}
    video{display:none}
  </style>
</head>
<body>

  <div id="ui">
    <div id="title">Toca para iniciar el video 360</div>
    <button id="btn">▶︎ Iniciar</button>
    <div id="note"></div>
  </div>

  <a-scene loading-screen="dotsColor: #29abe2; backgroundColor: black" renderer="antialias:true" background="color:#000" vr-mode-ui="enabled:true">
    <!-- Como en tu guía: a-sky con el id del video -->
    <a-assets>
      <video id="web360"
             crossorigin="anonymous"
             playsinline webkit-playsinline
             preload="auto" loop muted></video>
    </a-assets>

    <a-sky id="sky" rotation="0 -90 0" src="#web360"></a-sky>

    <a-entity camera look-controls wasd-controls position="0 0 0"></a-entity>
  </a-scene>

  <script>
    // ========= Config de URL =========
    const qs = new URLSearchParams(location.search);
    const src = qs.get("src") || "";            // pásalo como ?src=URL_MP4_DIRECTA
    const rotY = Number(qs.get("rotY") || -90); // ajusta frente si hace falta
    const title = qs.get("title") || "Video 360";

    const v = document.getElementById("web360");
    const sky = document.getElementById("sky");
    document.getElementById("title").textContent = title;
    sky.setAttribute("rotation", `0 ${rotY} 0`);

    // Si quieres dejar un DEFAULT local, descomenta y pega el Dropbox crudo:
    // v.src = "https://dl.dropboxusercontent.com/scl/fi/xxxx/mi-video.mp4?rlkey=yyyy";

    if (src) v.src = src;

    // ======== iOS: pedir permiso sensores en el mismo gesto ========
    async function askMotionPermissions(){
      try{
        if (typeof DeviceMotionEvent !== "undefined" &&
            typeof DeviceMotionEvent.requestPermission === "function"){
          await DeviceMotionEvent.requestPermission();
        }
      }catch(e){}
      try{
        if (typeof DeviceOrientationEvent !== "undefined" &&
            typeof DeviceOrientationEvent.requestPermission === "function"){
          await DeviceOrientationEvent.requestPermission();
        }
      }catch(e){}
    }

    // ======== “Truco” de tu guía: adelantar 0.1s antes de play ========
    function wakeVideo(){
      try { v.currentTime = 0.1; } catch(e){}
    }

    // Log básico (equivalente a tus mensajes)
    const note = document.getElementById("note");
    const log = (t)=> note.textContent = `${new Date().toLocaleTimeString()}: ${t}`;
    ["loadedmetadata","canplay","playing","stalled","waiting","error","ended"].forEach(ev=>{
      v.addEventListener(ev,()=>log(`video: ${ev}${v.error?` code=${v.error.code}`:""}`));
    });

    document.getElementById("btn").addEventListener("click", async ()=>{
      if (!v.src){
        alert("https://smartrabbitxr.github.io/smartrabbitxr/viewer.html?src=https://dl.dropboxusercontent.com/scl/fi/ucqf1zk9r0cdiawpl61w5/01-Isla-del-Coco.mp4?rlkey=vi95iy94guvs98265r2lp74ds&title=Isla%20del%20Coco&rotY=-90
");
        return;
      }
      await askMotionPermissions();
      wakeVideo();
      try{
        // iOS solo permite autoplay si está muted; luego puedes desmutear si se deja
        await v.play();
        v.muted = false;
      }catch(e){
        v.muted = true;
        await v.play().catch(()=>{});
      }
      document.getElementById("ui").style.display = "none";
    });
  </script>
</body>
</html>
