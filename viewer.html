<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Visor 360</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <style>
    html,body{margin:0;height:100%;background:#000}
    #topbar{position:fixed;left:12px;top:12px;z-index:20}
    #ui{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.85);color:#fff;z-index:15}
    #ui.hidden{display:none}
    button{border:0;border-radius:10px;padding:12px 16px;font-size:16px;font-weight:600;cursor:pointer}
    .primary{background:#2ecc71;color:#000}
    .ghost{background:#222;color:#fff}
    h2{margin:0 0 12px}
  </style>
</head>
<body>
  <div id="topbar">
    <button class="ghost" onclick="history.back()">← Videoteca</button>
  </div>

  <div id="ui">
    <h2 id="ttl">Video 360</h2>
    <button id="start" class="primary">▶︎ Tocar para iniciar</button>
  </div>

  <a-scene loading-screen="enabled:false" background="color: #000" vr-mode-ui="enabled: true">
    <a-assets>
      <video id="web360"
             crossorigin="anonymous"
             playsinline webkit-playsinline
             preload="auto"
             loop></video>
    </a-assets>

    <a-videosphere id="sphere" src="#web360" rotation="0 -90 0"></a-videosphere>
    <a-entity camera look-controls wasd-controls position="0 0 0"></a-entity>
  </a-scene>

  <script>
    // Lee parámetros ?src= ... &title= ... &rotY= ...
    const qs   = new URLSearchParams(location.search);
    const SRC  = qs.get('src') || "";          // URL mp4 Backblaze
    const TTL  = decodeURIComponent(qs.get('title') || "Video 360");
    const ROTY = Number(qs.get('rotY') || -90);

    const v   = document.getElementById('web360');
    const sky = document.getElementById('sphere');
    document.getElementById('ttl').textContent = TTL;
    sky.setAttribute('rotation', `0 ${ROTY} 0`);

    document.getElementById('start').addEventListener('click', async ()=>{
      if (!SRC){ alert('Falta ?src=URL_MP4'); return; }
      if (!v.src) v.src = SRC;

      // iOS: permiso para sensores (giroscopio)
      try{
        if (typeof DeviceMotionEvent !== "undefined" &&
            typeof DeviceMotionEvent.requestPermission === "function"){
          await DeviceMotionEvent.requestPermission().catch(()=>{});
        }
      }catch(e){}

      try{
        await v.play();
        v.muted = false;
      }catch(e){
        v.muted = true;             // fallback iOS
        await v.play().catch(()=>{});
      }
      document.getElementById('ui').classList.add('hidden');
    });
  </script>
</body>
</html>
